name: ci

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
    - name: Install deps
      run: |
          sudo apt update
          sudo apt install -y libgtk-3-dev libappindicator3-dev

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.13
      id: go

    - name: Install go tools
      run: |
        go get golang.org/x/lint/golint

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2

    - name: Build
      run: go build -v ./...

    - name: gofmt
      run: |
        GOFMTOUT=$(gofmt -l .)
        if [[ ! -z "${GOFMTOUT}" ]]; then
          echo "FATAL: gofmt violation(s), please fix"
          echo $GOFMTOUT
          exit -1
        fi

    - name: go vet
      run: go vet ./...

    - name: golint
      run: golint ./...

    - name: Test
      run: |
        docker run --rm -d -v $(pwd)/backend/schema.sql:/docker-entrypoint-initdb.d/schema.sql -e MYSQL_DATABASE=dev-db -e MYSQL_ROOT_PASSWORD=dev-root-password -e MYSQL_USER=dev-user -e MYSQL_PASSWORD=dev-user-password -p3306:3306 mysql
        while ! mysqladmin ping -h"127.0.0.1" --silent; do
          sleep 1
        done
        go test -v ./...
